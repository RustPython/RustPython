name: Update doc DB

permissions:
  contents: write
  pull-requests: write

on:
  workflow_dispatch:
    inputs:
      python-version:
        description: Target python version to generate doc db for
        type: string
        default: "3.14.3"
      base-ref:
        description: Base branch to create the update branch from
        type: string
        default: "main"

defaults:
  run:
    shell: bash

jobs:
  generate:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os:
          - ubuntu-latest
          - windows-latest
          - macos-latest
    steps:
      - uses: actions/checkout@0c366fd6a839edf440554fa01a7085ccba70ac98 # v6.0.1
        with:
          persist-credentials: false
          sparse-checkout: |
            crates/doc

      - uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405 # v6.2.0
        with:
          python-version: ${{ inputs.python-version }}

      - name: Generate docs
        run: python crates/doc/generate.py

      - uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: doc-db-${{ inputs.python-version }}-${{ matrix.os }}
          path: "crates/doc/generated/*.json"
          if-no-files-found: error
          retention-days: 7
          overwrite: true

  merge:
    runs-on: ubuntu-latest
    needs: generate
    steps:
      - uses: actions/checkout@0c366fd6a839edf440554fa01a7085ccba70ac98 # v6.0.1
        with:
          ref: ${{ inputs.base-ref }}
          token: ${{ secrets.AUTO_COMMIT_PAT }}

      - name: Create update branch
        run: git switch -c update-doc-${{ inputs.python-version }}

      - name: Download generated doc DBs
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          pattern: "doc-db-${{ inputs.python-version }}-**"
          path: crates/doc/generated/
          merge-multiple: true

      - name: Transform JSON
        run: |
          # Merge all artifacts
          jq -s "add" --sort-keys crates/doc/generated/*.json > crates/doc/generated/merged.json

          # Format merged json for the phf macro
          jq -r 'to_entries[] | "    \(.key | @json) => \(.value | @json),"' crates/doc/generated/merged.json > crates/doc/generated/raw_entries.txt

          OUTPUT_FILE='crates/doc/src/data.inc.rs'

          echo -n '' > $OUTPUT_FILE

          echo '// This file was auto-generated by `.github/workflows/update-doc-db.yml`.' >> $OUTPUT_FILE
          echo "// CPython version: ${{ inputs.python-version }}" >> $OUTPUT_FILE
          echo '// spell-checker: disable' >> $OUTPUT_FILE

          echo '' >> $OUTPUT_FILE

          echo "pub static DB: phf::Map<&'static str, &'static str> = phf::phf_map! {" >> $OUTPUT_FILE
          cat crates/doc/generated/raw_entries.txt >> $OUTPUT_FILE
          echo '};' >> $OUTPUT_FILE

      - uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: doc-db-${{ inputs.python-version }}
          path: "crates/doc/src/data.inc.rs"
          if-no-files-found: error
          retention-days: 7
          overwrite: true

      - name: Commit, push and create PR
        env:
          GH_TOKEN: ${{ secrets.AUTO_COMMIT_PAT }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          if [ -n "$(git status --porcelain)" ]; then
            git add crates/doc/src/data.inc.rs
            git commit -m "Update doc DB for CPython ${{ inputs.python-version }}"
            git push -u origin HEAD
            gh pr create \
              --base ${{ inputs.base-ref }} \
              --title "Update doc DB for CPython ${{ inputs.python-version }}" \
              --body "Auto-generated by update-doc-db workflow."
          fi
